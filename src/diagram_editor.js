var pointer = "<g transform='translate(881.10358,-356.22543)'>\n      <g transform='matrix(0.8660254,-0.5,0.5,0.8660254,-266.51112,-215.31898)'>\n        <path\n           d='m -797.14902,212.29589 a 5.6610848,8.6573169 0 0 0 -4.61823,4.3125 l -28.3428,75.0625 a 5.6610848,8.6573169 0 0 0 4.90431,13 l 56.68561,0 a 5.6610848,8.6573169 0 0 0 4.9043,-13 l -28.3428,-75.0625 a 5.6610848,8.6573169 0 0 0 -5.19039,-4.3125 z m 0.28608,25.96875 18.53419,49.09375 -37.06838,0 18.53419,-49.09375 z'\n        />\n        <path\n           d='m -801.84375,290.40625 c -2.09434,2.1e-4 -3.99979,1.90566 -4,4 l 0,35.25 c 2.1e-4,2.09434 1.90566,3.99979 4,4 l 10,0 c 2.09434,-2.1e-4 3.99979,-1.90566 4,-4 l 0,-35.25 c -2.1e-4,-2.09434 -1.90566,-3.99979 -4,-4 z'\n        />\n      </g>\n    </g>\n";
var add_node = "<g transform='translate(720.71649,-356.22543)'>\n      <g transform='translate(-3.8571429,146.42857)'>\n        <path\n           d='m -658.27638,248.37149 c -1.95543,0.19978 -3.60373,2.03442 -3.59375,4 l 0,12.40625 -12.40625,0 c -2.09434,2.1e-4 -3.99979,1.90566 -4,4 l 0,10 c -0.007,0.1353 -0.007,0.27095 0,0.40625 0.19978,1.95543 2.03442,3.60373 4,3.59375 l 12.40625,0 0,12.4375 c 2.1e-4,2.09434 1.90566,3.99979 4,4 l 10,0 c 2.09434,-2.1e-4 3.99979,-1.90566 4,-4 l 0,-12.4375 12.4375,0 c 2.09434,-2.1e-4 3.99979,-1.90566 4,-4 l 0,-10 c -2.1e-4,-2.09434 -1.90566,-3.99979 -4,-4 l -12.4375,0 0,-12.40625 c -2.1e-4,-2.09434 -1.90566,-3.99979 -4,-4 l -10,0 c -0.1353,-0.007 -0.27095,-0.007 -0.40625,0 z'\n        />\n        <path\n           d='m -652.84375,213.9375 c -32.97528,0 -59.875,26.86847 -59.875,59.84375 0,32.97528 26.89972,59.875 59.875,59.875 32.97528,0 59.84375,-26.89972 59.84375,-59.875 0,-32.97528 -26.86847,-59.84375 -59.84375,-59.84375 z m 0,14 c 25.40911,0 45.84375,20.43464 45.84375,45.84375 0,25.40911 -20.43464,45.875 -45.84375,45.875 -25.40911,0 -45.875,-20.46589 -45.875,-45.875 0,-25.40911 20.46589,-45.84375 45.875,-45.84375 z'\n        />\n      </g>\n    </g>";
var add_link ="<g transform='translate(557.53125,-356.22543)'>\n    <g transform='translate(20,0)'>\n      <path\n         d='m -480.84375,360 c -15.02602,0 -27.375,12.31773 -27.375,27.34375 0,4.24084 1.00221,8.28018 2.75,11.875 l -28.875,28.875 c -3.59505,-1.74807 -7.6338,-2.75 -11.875,-2.75 -15.02602,0 -27.34375,12.34898 -27.34375,27.375 0,15.02602 12.31773,27.34375 27.34375,27.34375 15.02602,0 27.375,-12.31773 27.375,-27.34375 0,-4.26067 -0.98685,-8.29868 -2.75,-11.90625 L -492.75,411.96875 c 3.60156,1.75589 7.65494,2.75 11.90625,2.75 15.02602,0 27.34375,-12.34898 27.34375,-27.375 C -453.5,372.31773 -465.81773,360 -480.84375,360 z m 0,14 c 7.45986,0 13.34375,5.88389 13.34375,13.34375 0,7.45986 -5.88389,13.375 -13.34375,13.375 -7.45986,0 -13.375,-5.91514 -13.375,-13.375 0,-7.45986 5.91514,-13.34375 13.375,-13.34375 z m -65.375,65.34375 c 7.45986,0 13.34375,5.91514 13.34375,13.375 0,7.45986 -5.88389,13.34375 -13.34375,13.34375 -7.45986,0 -13.34375,-5.88389 -13.34375,-13.34375 0,-7.45986 5.88389,-13.375 13.34375,-13.375 z'\n      />\n      <path\n         d='m -484.34375,429.25 c -1.95543,0.19978 -3.60373,2.03442 -3.59375,4 l 0,12.40625 -12.40625,0 c -2.09434,2.1e-4 -3.99979,1.90566 -4,4 l 0,10 c -0.007,0.1353 -0.007,0.27095 0,0.40625 0.19978,1.95543 2.03442,3.60373 4,3.59375 l 12.40625,0 0,12.4375 c 2.1e-4,2.09434 1.90566,3.99979 4,4 l 10,0 c 2.09434,-2.1e-4 3.99979,-1.90566 4,-4 l 0,-12.4375 12.4375,0 c 2.09434,-2.1e-4 3.99979,-1.90566 4,-4 l 0,-10 c -2.1e-4,-2.09434 -1.90566,-3.99979 -4,-4 l -12.4375,0 0,-12.40625 c -2.1e-4,-2.09434 -1.90566,-3.99979 -4,-4 l -10,0 c -0.1353,-0.007 -0.27095,-0.007 -0.40625,0 z'\n      />\n    </g>\n  </g>\n";


class EditorState{
    constructor(){
        this.selectedNodes = [];
        this.selectedLinks = [];
        this.currentTool = "selection";
        this.pressedKey = ""
    }
}

class Diagram{
    constructor(){
        this.nodes = {}
        this.links = []
    }

    addNode(node){
    }

    deleteNodes(nodes){
    }

    addLink(){
    }

    deleteLink(){
    }
}

class DiagramEditor extends HTMLElement {
    constructor() {
        super();
        // создаем editor, контрльную панель и канву
        this.makeGraphCanvas();

        this.state = new EditorState();
        this.addDefaultElements()

        this.selectedElement = null;
        this.offset = null;
        this.transform = null;

        this.svg.onmousemove = (event)=> {
            this.drag(event)
        }
        this.svg.onmouseup = (event) => {
            this.endDrag(event)
        }
        this.svg.onmousedown = (event) => {
            if (this.state.currentTool == "selection"){
                this.startDrag(event)
            }
            else if (this.state.currentTool == "add_node"){
                this.addNode(event)
            }
        }
        this.svg.onmouseleave = (event) => {
            this.endDrag(event)
        }
        this.svg.addEventListener('keydown', event => {
            console.log('svg keydown: ', event.key);
        });

        this.items = [];
    };

    addDefaultElements(){
        // Создание дефолтных элементов
        var draggableRect = document.createElementNS("http://www.w3.org/2000/svg", "rect");
        draggableRect.setAttribute("class", "draggable");
        draggableRect.setAttribute("x", 4);
        draggableRect.setAttribute("y", 5);
        draggableRect.setAttribute("width", 8);
        draggableRect.setAttribute("height", 10);

        var staticRect = document.createElementNS("http://www.w3.org/2000/svg", "rect");
        staticRect.setAttribute("class", "static");
        staticRect.setAttribute("x", 18);
        staticRect.setAttribute("y", 5);
        staticRect.setAttribute("width", 8);
        staticRect.setAttribute("height", 10);
        this.svg.appendChild(draggableRect);
        this.svg.appendChild(staticRect);
    }

    getMousePosition(evt) {
        // ToDo: Разобрать
        var CTM = this.svg.getScreenCTM();
        return {
            x: (evt.clientX - CTM.e) / CTM.a,
            y: (evt.clientY - CTM.f) / CTM.d
        };
    };

    makeGraphCanvas()  {
        this.attachShadow({ mode: "open" });
        this.editor = document.createElement("div")
        // функция для развёртывания основной svg канвы
        // создание канвы
        this.svg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
        this.svg.setAttribute("viewBox", "0 0 30 20");
        // tabindex 0, чтобы работал onkeypress
        this.svg.setAttribute("tabindex", "0");
        // подготовка заднего фона
        var backgroundRect = document.createElementNS("http://www.w3.org/2000/svg", "rect");
        backgroundRect.setAttribute("class", "canv_background");
        backgroundRect.setAttribute("x", 0);
        backgroundRect.setAttribute("y", 0);
        backgroundRect.setAttribute("width", 30);
        backgroundRect.setAttribute("height", 20);
        backgroundRect.setAttribute("fill", "#fafafa");

        this.svg.appendChild(backgroundRect);
        this.editor.appendChild(this.svg);
        this.shadowRoot.appendChild(this.editor);
        // контрольная панель с кнопками
        this.controlPanel = new ControlPanel(this)
        this.editor.appendChild(this.controlPanel.getView())
    }

    startDrag(evt) {
        if (evt.target.classList.contains('draggable')) {
            this.selectedElement = evt.target;
            this.offset = this.getMousePosition(evt);
            // Get all the transforms currently on this element
            var transforms = this.selectedElement.transform.baseVal;
            // Ensure the first transform is a translate transform
            if (transforms.length === 0 || transforms.getItem(0).type !== SVGTransform.SVG_TRANSFORM_TRANSLATE) {
                // Create an transform that translates by (0, 0)
                var translate = this.svg.createSVGTransform();
                translate.setTranslate(0, 0);
                // Add the translation to the front of the transforms list
                this.selectedElement.transform.baseVal.insertItemBefore(translate, 0);
            }
            // Get initial translation amount
            this.transform = transforms.getItem(0);
            this.offset.x -= this.transform.matrix.e;
            this.offset.y -= this.transform.matrix.f;
        }
    };

    addNode(evt){
        var newDraggableRect = document.createElementNS("http://www.w3.org/2000/svg", "rect");
        newDraggableRect.setAttribute("class", "draggable");
        newDraggableRect.setAttribute("x", 4);
        newDraggableRect.setAttribute("y", 5);
        newDraggableRect.setAttribute("width", 8);
        newDraggableRect.setAttribute("height", 10);

        var transforms = newDraggableRect.transform.baseVal;
        // Ensure the first transform is a translate transform
        if (transforms.length === 0 || transforms.getItem(0).type !== SVGTransform.SVG_TRANSFORM_TRANSLATE) {
            // Create an transform that translates by (0, 0)
            var translate = this.svg.createSVGTransform();
            translate.setTranslate(0, 0);
            // Add the translation to the front of the transforms list
            newDraggableRect.transform.baseVal.insertItemBefore(translate, 0);
        }
        // Get initial translation amount
        this.transform = transforms.getItem(0);
        this.offset.x -= this.transform.matrix.e;
        this.offset.y -= this.transform.matrix.f;

        var coord = this.getMousePosition(evt);
        this.transform.setTranslate(coord.x - this.offset.x, coord.y - this.offset.y);
        this.svg.appendChild(newDraggableRect);
        this.selectedElement = null;
    }

    drag(evt) {
        if (this.selectedElement){
            evt.preventDefault();
            var coord = this.getMousePosition(evt);
            this.transform.setTranslate(coord.x - this.offset.x, coord.y - this.offset.y);
        }
    };

    endDrag(evt) {
        this.selectedElement = null;
    };
}

customElements.define("diagram-editor", DiagramEditor);
